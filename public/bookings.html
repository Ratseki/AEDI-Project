<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Your Session — ProfilePicMultimedia</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .bk-page { padding: 140px 40px 80px; background: #f4f4f4; min-height: 100vh; color: #0A142D; }
    .bk-container { max-width: 800px; margin: 0 auto; background: rgba(255,255,255,0.95); border-left: 6px solid #CE6826; padding: 30px; border-radius: 8px; box-shadow: 0 6px 30px rgba(0,0,0,0.08);}
    .bk-title { font-size: 28px; font-weight:700; color:#0A142D; margin-bottom: 20px; letter-spacing: 1px;}
    .bk-row { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:14px; }
    .bk-col { flex:1; min-width:200px; display:flex; flex-direction:column; }
    .bk-input, .bk-select { padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    .bk-label { font-size:13px; margin-bottom:6px; color:#0A142D; font-weight:600; }
    .bk-required { color: #e03b3b; margin-left:4px; }
    .bk-actions { display:flex; gap:12px; align-items:center; margin-top:10px; }
    .bk-btn { background:#CE6826; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-weight:600; }
    .bk-btn.secondary { background:#F9BF5F; color:#0A142D; }
    .bk-summary { background:#F9BF5F20; padding:12px; border-radius:6px; margin-top:10px; }
    .bk-error { border:1px solid #e03b3b; background:#ffecec; color:#a80000; padding:8px; border-radius:6px; margin-top:6px; }
    option[disabled]:hover { cursor: not-allowed; }
    @media (max-width:900px){ .bk-row {flex-direction:column;} .bk-col{min-width: unset;} }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="logo"><img src="images/logo_test.png" alt="logo" style="height:64px;"></div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="bookings.html" class="active">Bookings</a>
    </nav>
  </header>

  <main class="bk-page">
    <div class="bk-container">
      <h1 class="bk-title">BOOK YOUR SESSION</h1>

      <form id="bkForm" onsubmit="return false;">
        <!-- Basic Info -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">First Name <span class="bk-required">*</span></label>
            <input id="firstName" class="bk-input" required />
          </div>
          <div class="bk-col">
            <label class="bk-label">Last Name <span class="bk-required">*</span></label>
            <input id="lastName" class="bk-input" required />
          </div>
        </div>

        <!-- Contact Info -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">E-mail <span class="bk-required">*</span></label>
            <input id="email" type="email" class="bk-input" placeholder="myname@example.com" required />
          </div>
          <div class="bk-col">
            <label class="bk-label">Phone Number <span class="bk-required">*</span></label>
            <div style="display:flex;gap:8px;">
              <input id="phoneArea" class="bk-input" placeholder="Area" style="width:90px" required />
              <input id="phoneNumber" class="bk-input" placeholder="Phone number" required />
            </div>
          </div>
        </div>

       
        <div class="bk-row">
          <div class="bk-col" style="flex: 2 1 100%;">
            <label class="bk-label">Street Address <span class="bk-required">*</span></label>
            <input id="address" class="bk-input" required />
          </div>
        </div>

        <!-- Date & Time -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">Select Appointment Date <span class="bk-required">*</span></label>
            <input id="date" class="bk-input" type="date" required />
          </div>

          <div class="bk-col">
            <label class="bk-label">Select Time <span class="bk-required">*</span></label>
            <select id="time" class="bk-select" required>
              <option value="">-- select a time --</option>
              <option>08:00</option>
              <option>09:00</option>
              <option>10:00</option>
              <option>11:00</option>
              <option>12:00</option>
              <option>13:00</option>
              <option>14:00</option>
              <option>15:00</option>
              <option>16:00</option>
              <option>17:00</option>
            </select>
            <div style="font-size:13px;margin-top:6px;">Timezone: <span id="detectedTz"></span></div>
          </div>
        </div>

        <!-- Location & Package -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">Session Location <span class="bk-required">*</span></label>
            <select id="location" class="bk-select" required>
              <option value="">Please select</option>
              <option value="Paoay, Ilocos Norte">Paoay, Ilocos Norte</option>
              <option value="Daraga, Albay" disabled title="Coming soon">Daraga, Albay (Coming Soon)</option>
              <option value="Carmen, Bohol" disabled title="Coming soon">Carmen, Bohol (Coming Soon)</option>
              <option value="La Union" disabled title="Coming soon">La Union (Coming Soon)</option>
            </select>
          </div>

          <div class="bk-col">
            <label class="bk-label">Package <span class="bk-required">*</span></label>
            <select id="package" class="bk-select" required>
              <option value="">Please select</option>
              <option value="1" data-price="40">Pro — ₱40</option>
              <option value="2" data-price="25">Plus — ₱25</option>
              <option value="3" data-price="10">Standard — ₱10</option>
            </select>
          </div>
        </div>

        <div class="bk-col">
        <label class="bk-label">Payment Method <span class="bk-required">*</span></label>
        <select id="paymentMethod" class="bk-select" required>
          <option value="">Please select</option>
          <option value="gcash">GCash</option>
          <option value="card">Credit/Debit Card</option>
          <option value="maya" disabled title="Coming soon">Maya (Coming Soon)</option>
        </select>
      </div>



        <!-- Agreement -->
        <div style="margin-top:12px;">
          <label class="bk-label">Agreement <span class="bk-required">*</span></label>
          <div style="background:#fff; padding:12px; border-radius:6px; border:1px solid #eee;">
            <p style="font-size:13px;">By submitting you agree to our terms and consent to model release and copyright terms.</p>
          </div>
          <label style="display:block; margin-top:8px;"><input id="agree" type="checkbox" /> I agree</label>
        </div>

        <div id="bkError" class="bk-error" style="display:none;"></div>
        <div class="bk-summary" id="bkSummary" style="display:none;"></div>

        <div class="bk-actions">
          <button id="bkSubmit" class="bk-btn">Continue to Payment</button>
          <button id="bkClear" class="bk-btn secondary" type="button">Reset</button>
        </div>
      </form>
    </div>
  </main>

  <footer style="padding:40px; text-align:center; color:#777;">&copy; 2025 ProfilePicMultimedia</footer>

  <script>
  // Detect timezone
  document.getElementById('detectedTz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';

  // Disable past dates
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("date").setAttribute("min", today);

  // === Currency conversion rate (USD → PHP) ===
  const USD_TO_PHP = 58;

  // Show converted price automatically
  const pkgSelect = document.getElementById("package");
  pkgSelect.addEventListener("change", () => {
    const usd = parseFloat(pkgSelect.selectedOptions[0].dataset.price || 0);
    if (usd > 0) {
      const php = usd * USD_TO_PHP;
      alert(`Selected package price: ₱${php.toLocaleString()} (≈ $${usd})`);
    }
  });

  function showError(msg){
    const el = document.getElementById('bkError');
    el.style.display='block';
    el.textContent=msg;
  }
  function clearError(){
    const el = document.getElementById('bkError');
    el.style.display='none';
    el.textContent='';
  }

  document.getElementById('bkClear').addEventListener('click', ()=>{
    document.getElementById('bkForm').reset();
    clearError();
    document.getElementById('bkSummary').style.display='none';
  });

  document.getElementById('bkSubmit').addEventListener('click', async ()=>{
    clearError();

    const firstName = document.getElementById("firstName").value.trim();
    const lastName = document.getElementById("lastName").value.trim();
    const email = document.getElementById("email").value.trim();
    const phoneArea = document.getElementById("phoneArea").value.trim();
    const phoneNumber = document.getElementById("phoneNumber").value.trim();
    const date = document.getElementById("date").value;
    const time = document.getElementById("time").value;
    const location = document.getElementById("location").value;
    const pkgOption = pkgSelect.selectedOptions[0];
    const service_id = pkgOption.value;
    const usd = parseFloat(pkgOption.dataset.price || 0);
    const php = usd * USD_TO_PHP;
    const pkg = pkgOption.text;
    
    const method = document.getElementById("paymentMethod").value;
    if (!method) {
      showError("Please select a payment method.");
      return;
    }

    const agree = document.getElementById("agree").checked;

    if(!firstName || !lastName || !email || !phoneNumber || !date || !time || !location || !pkg || !agree){
      showError("Please fill all required fields and accept the agreement.");
      return;
    }

    const token = localStorage.getItem("token");
    if (!token) {
      alert("Please log in to continue.");
      window.location.href = "/login.html";
      return;
    }

    const payload = {
      first_name: firstName,
      last_name: lastName,
      email,
      phone_area: phoneArea,
      phone_number: phoneNumber,
      date,
      time,
      location,
      package_name: pkg,
      service_id,
      amount: php
    };

    try {
      const res = await fetch("/api/bookings", {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":"Bearer " + token
        },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!res.ok) {
        showError(data.message || "Server error");
        return;
      }

      const s = document.getElementById("bkSummary");
      s.style.display="block";
      s.innerHTML = `
        <strong>Booking created ✅</strong><br>
        Booking ID: ${data.booking_id}<br>
        Package: ${payload.package_name}<br>
        Total Amount: ₱${php.toLocaleString()}<br>
        Date: ${payload.date} ${payload.time}<br>
        <div style="margin-top:8px;">
          <button class="bk-btn" onclick="proceedToPayment(${data.booking_id}, ${php}, '${method}')">Proceed to Payment</button>
        </div>
      `;
    } catch (err){
      console.error(err);
      showError("Network error.");
    }
  });

  // === Payment redirect ===
 async function proceedToPayment(bookingId, amount, method) {
  const token = localStorage.getItem("token");
  try {
    const res = await fetch("/api/payments/create-checkout-session", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({
        amount,
        booking_id: bookingId,
        method
      })
    });

    const data = await res.json();
    if (!res.ok) {
      alert(`⚠️ Payment failed: ${data.message}`);
      return;
    }

    window.location.href = data.checkout_url;
  } catch (err) {
    console.error("❌ Payment error:", err);
    alert("Server error while creating checkout session.");
  }
}

</script>

</body>
</html>
