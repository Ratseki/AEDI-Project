<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Book Your Session — ProfilePicMultimedia</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Local bookings styles (prefixed with bk- to avoid clashes) */
    .bk-page { padding: 140px 40px 80px; background: #f4f4f4; min-height: 100vh; color: #0A142D; }
    .bk-container { max-width: 1100px; margin: 0 auto; background: rgba(255,255,255,0.95); border-left: 6px solid #CE6826; padding: 30px; border-radius: 8px; box-shadow: 0 6px 30px rgba(0,0,0,0.08);}
    .bk-title { font-size: 28px; font-weight:700; color:#0A142D; margin-bottom: 20px; letter-spacing: 1px;}
    .bk-row { display:flex; gap:16px; flex-wrap:wrap; margin-bottom:14px; }
    .bk-col { flex:1; min-width:200px; display:flex; flex-direction:column; }
    .bk-input, .bk-select, .bk-textarea { padding:10px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
    .bk-label { font-size:13px; margin-bottom:6px; color:#0A142D; font-weight:600; }
    .bk-required { color: #e03b3b; margin-left:4px; }
    .bk-actions { display:flex; gap:12px; align-items:center; margin-top:10px; }
    .bk-btn { background:#CE6826; color:#fff; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; font-weight:600; }
    .bk-btn.secondary { background:#F9BF5F; color:#0A142D; }
    .bk-summary { background:#F9BF5F20; padding:12px; border-radius:6px; margin-top:10px; }
    .bk-error { border:1px solid #e03b3b; background: #ffecec; color:#a80000; padding:8px; border-radius:6px; margin-top:6px; }
    .bk-small { font-size:13px; color:#444; }
    .bk-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.45); justify-content:center; align-items:center; z-index:9999; }
    .bk-modal .bk-modal-content { background:#fff; padding:22px; border-radius:8px; width:360px; }
    .bk-field-inline { display:flex; gap:8px; }
    @media (max-width:900px){ .bk-row {flex-direction:column;} .bk-col{min-width: unset;} }
  </style>
</head>
<body>
  <header class="navbar"> <!-- you already have navbar styles in main CSS, this keeps it consistent -->
    <div class="logo"><img src="images/logo_test.png" alt="logo" style="height:64px;"></div>
    <nav class="nav-links">
      <a href="index.html">Home</a>
      <a href="bookings.html" class="active">Bookings</a>
    </nav>
  </header>

  <main class="bk-page">
    <div class="bk-container" role="main">
      <h1 class="bk-title">BOOK YOUR SESSION</h1>

      <!-- FORM -->
      <form id="bkForm" class="bk-form" onsubmit="return false;">
        <!-- Name -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">First Name <span class="bk-required">*</span></label>
            <input id="firstName" class="bk-input" required />
          </div>
          <div class="bk-col">
            <label class="bk-label">Last Name <span class="bk-required">*</span></label>
            <input id="lastName" class="bk-input" required />
          </div>
        </div>

        <!-- Email & Phone -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">E-mail <span class="bk-required">*</span></label>
            <input id="email" type="email" class="bk-input" placeholder="myname@example.com" required />
          </div>
          <div class="bk-col">
            <label class="bk-label">Phone Number <span class="bk-required">*</span></label>
            <div class="bk-field-inline">
              <input id="phoneArea" class="bk-input" placeholder="Area" style="width:90px" required />
              <input id="phoneNumber" class="bk-input" placeholder="Phone number" required />
            </div>
          </div>
        </div>

        <!-- Address (simple fields) -->
        <div class="bk-row">
          <div class="bk-col" style="flex: 2 1 100%;">
            <label class="bk-label">Street Address <span class="bk-required">*</span></label>
            <input id="address" class="bk-input" required />
          </div>
        </div>

        <!-- Date & Time + Timezone info -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">Select Appointment Date <span class="bk-required">*</span></label>
            <input id="date" class="bk-input" type="date" required />
          </div>

          <div class="bk-col">
            <label class="bk-label">Select Time <span class="bk-required">*</span></label>
            <select id="time" class="bk-select" required>
              <option value="">-- select a time --</option>
              <option>08:00</option>
              <option>09:00</option>
              <option>10:00</option>
              <option>11:00</option>
              <option>12:00</option>
              <option>13:00</option>
              <option>14:00</option>
              <option>15:00</option>
              <option>16:00</option>
              <option>17:00</option>
            </select>
            <div class="bk-small" style="margin-top:6px;">Timezone: <span id="detectedTz"></span></div>
          </div>
        </div>

        <!-- Location & Package -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">Session Location <span class="bk-required">*</span></label>
            <select id="location" class="bk-select" required>
              <option value="">Please select</option>
              <option>Paoay, Ilocos Norte</option>
              <option>Daraga, Albay</option>
              <option>Carmen, Bohol</option>
              <option>La Union</option>
            </select>
          </div>

          <div class="bk-col">
            <label class="bk-label">Package <span class="bk-required">*</span></label>
            <select id="package" class="bk-select" required>
              <option value="">Please select</option>
              <option value="1">Pro — $40</option>
              <option value="2">Plus — $25</option>
              <option value="3">Standard — $10</option>
            </select>
          </div>
        </div>

        <!-- Extras -->
        <div class="bk-row">
          <div class="bk-col">
            <label class="bk-label">Number of People</label>
            <input id="numPeople" class="bk-input" type="number" min="1" />
          </div>
          <div class="bk-col">
            <label class="bk-label">Note to Photographer</label>
            <input id="note" class="bk-input" />
          </div>
        </div>

        <!-- Agreement (short) -->
        <div style="margin-top:12px;">
          <label class="bk-label">Agreement <span class="bk-required">*</span></label>
          <div style="background:#fff; padding:12px; border-radius:6px; border:1px solid #eee; color:#333; max-height:120px; overflow:auto;">
            <p style="font-size:13px;">By submitting you agree to our terms and consent to model release and copyright terms.</p>
          </div>
          <label style="display:block; margin-top:8px;"><input id="agree" type="checkbox" /> I agree</label>
        </div>

        <!-- Validation / summary -->
        <div id="bkError" class="bk-error" style="display:none;"></div>
        <div class="bk-summary" id="bkSummary" style="display:none;"></div>

        <!-- Actions -->
        <div class="bk-actions">
          <button id="bkSubmit" class="bk-btn">Continue to Payment</button>
          <button id="bkClear" class="bk-btn secondary" type="button">Reset</button>
        </div>
      </form>
    </div>
  </main>

  <!-- Downpayment modal (for admin/optional) -->
  <div id="bkDownModal" class="bk-modal" role="dialog" aria-hidden="true">
    <div class="bk-modal-content">
      <h3>Confirm Downpayment</h3>
      <input id="bkDownAmount" class="bk-input" type="number" placeholder="Enter amount" />
      <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
        <button class="bk-btn" onclick="submitDownpaymentModal()">Confirm</button>
        <button class="bk-btn secondary" onclick="closeDownModal()">Cancel</button>
      </div>
    </div>
  </div>

  <footer style="padding:40px; text-align:center; color:#777;">&copy; 2025 ProfilePicMultimedia</footer>

  <script>
    // Detect timezone display
    document.getElementById('detectedTz').textContent = Intl.DateTimeFormat().resolvedOptions().timeZone || 'Local';

    // Helper: show error
    function showError(msg){
      const el = document.getElementById('bkError');
      el.style.display = 'block';
      el.textContent = msg;
    }
    function clearError(){
      const el = document.getElementById('bkError');
      el.style.display = 'none';
      el.textContent = '';
    }

    // Reset form
    document.getElementById('bkClear').addEventListener('click', () => {
      document.getElementById('bkForm').reset();
      document.getElementById('bkSummary').style.display='none';
      clearError();
    });

    // Submit booking
    document.getElementById('bkSubmit').addEventListener('click', async () => {
      clearError();
      // Basic validation
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phoneArea = document.getElementById('phoneArea').value.trim();
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const location = document.getElementById('location').value;
      const serviceId = document.getElementById('package').value; // <-- this is the service_id
      const agree = document.getElementById('agree').checked;
      

      if (!firstName || !lastName || !email || !phoneNumber || !date || !time || !location || !pkg || !agree) {
        showError('Please fill all required fields and accept the agreement.');
        return;
      }

      // require login (JWT in localStorage)
      const token = localStorage.getItem('token');
      if (!token) {
        // redirect to login, preserve form data maybe
        localStorage.setItem('afterBooking', JSON.stringify({ firstName, lastName, email, phoneArea, phoneNumber, date, time, location, pkg }));
        alert('Please log in or sign up to continue. You will be redirected to login page.');
        window.location.href = '/login.html';
        return;
      }

      // Build payload
      const payload = {
      first_name: firstName,
      last_name: lastName,
      email,
      phone_area: phoneArea,
      phone_number: phoneNumber,
      date,
      time,
      location,
      package: pkg,           // optional, can keep for display
      note: document.getElementById('note').value || '',
      num_people: document.getElementById('numPeople').value || 1,
      service_id: serviceId    // <-- ADD THIS
    };

      try {
        const res = await fetch('/api/bookings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const t = await res.json().catch(()=>null);
          showError((t && t.message) || 'Server error - could not create booking.');
          return;
        }
        const data = await res.json();

        // success -> show summary and redirect to payment step or show inline message
        const s = document.getElementById('bkSummary');
        s.style.display = 'block';
        s.innerHTML = `
          <strong>Booking created ✅</strong><br>
          Booking ID: ${data.booking_id}<br>
          Package: ${payload.package}<br>
          Date: ${payload.date} ${payload.time}<br>
          <div style="margin-top:8px;">
            <button class="bk-btn" onclick="gotoPayment(${data.booking_id})">Proceed to Payment</button>
            <button class="bk-btn secondary" onclick="openDownModal(${data.booking_id})">Add Downpayment</button>
          </div>
        `;
        // optionally clear form
      } catch (err) {
        console.error(err);
        showError('Network error. Please try again later.');
      }
    });

    // Payment navigation placeholder
    function gotoPayment(bookingId){
      // For now just alert — you should create a proper payments page or modal
      window.location.href = `/payments.html?booking_id=${bookingId}`;
    }

    // Downpayment modal
    let bkModalBookingId = null;
    function openDownModal(bookingId){
      bkModalBookingId = bookingId;
      document.getElementById('bkDownModal').style.display = 'flex';
    }
    function closeDownModal(){
      document.getElementById('bkDownModal').style.display = 'none';
      bkModalBookingId = null;
    }
    async function submitDownpayment(bkModalBookingId, amount) {
  try {
    const token = localStorage.getItem('token');
    if (!token) {
      alert('You must be logged in to make a downpayment.');
      return;
    }

    const res = await fetch('http://localhost:3000/api/bookings/downpayment', {
    method: 'POST',
    headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + token
  },
  body: JSON.stringify({ booking_id: bkModalBookingId, amount })
});


    const result = await res.json();

    if (!res.ok) {
      alert(result.message || 'Downpayment failed');
      return;
    }

    alert(result.message || 'Downpayment successful!');
    closeDownModal();

  } catch (err) {
    console.error('❌ Downpayment error:', err);
    alert('Server error. Please try again later.');
  }
}

    // close modal on background click
    document.getElementById('bkDownModal').addEventListener('click', (e)=> {
      if (e.target === document.getElementById('bkDownModal')) closeDownModal();
    });

    // Optional: pre-fill form if user was redirected to login
    (function restoreAfterLogin(){
      const storage = localStorage.getItem('afterBooking');
      if (storage) {
        try {
          const obj = JSON.parse(storage);
          document.getElementById('firstName').value = obj.firstName || '';
          document.getElementById('lastName').value = obj.lastName || '';
          document.getElementById('email').value = obj.email || '';
          document.getElementById('phoneArea').value = obj.phoneArea || '';
          document.getElementById('phoneNumber').value = obj.phoneNumber || '';
          document.getElementById('date').value = obj.date || '';
          document.getElementById('time').value = obj.time || '';
          document.getElementById('location').value = obj.location || '';
          document.getElementById('package').value = obj.pkg || '';
          localStorage.removeItem('afterBooking');
        } catch(e){ /* ignore */ }
      }
    })();
  </script>
</body>
</html>
